------------------------------------------------------------------------

---
output: html_document
editor_options: 
  chunk_output_type: console
---

------------------------------------------------------------------------

---
title: "Vignette2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data_Processing_MSstatsTMT}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
#With dataset 1, this vignette will outline MSstatsTMT processed datasets at the peptide level and evaluate TPP spline, NPARC sigmoid, SCAM splines and MSstatsTMT statistical modeling.
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include=TRUE}
devtools::load_all(".")

```

Library setup

```{r setup}

library(MSstats)
library(MSstatsConvert)
library(MSstatsTMT)
library(tidyr)
library(stringr)
library(TPP)
library(NPARC)
library(ggplot2)
library(ggrepel)
theme_set(theme_bw())

```

# A.Data Import: Place your PD files in a folder

### Import option 1: Read in your own file

**Use WD\<-your_working_directory to get a folder where your PSM data is stored**

```{r}
workingDirectory<-"~/Dataset_1/Fractions CFE"

h<-list.files(workingDirectory,pattern="PSMs")|>as.list()
 
df<-purrr::map(h,function(x) readxl::read_xlsx(path=paste0(workingDirectory,"/",x),.name_repair = "universal")) |> dplyr::bind_rows()
```

### Import option 2: Use the example file

**load the peptide spectrum match (PSM) example file into R**

```{r}
data("PSMsample_HumanData", package = "MSstatsThermalProfiler")
df<-PSMsample_HumanData
names(df)<-stringr::str_replace_all(names(df)," ",".")
```
Annotation File Generation: 

### Rename the columns from the PSM file and generate annotation file

**Generate annotation file**

```{r}

pd_annotation<-Annotation2MSstatsTMT(df,solvent="DMSO",temps=set_temps(10,c(37.3, 40.6, 43.9, 47.2, 50.5, 53.8, 57.1, 60.4, 64, 67)),reference="126",CARRIER=TRUE)


```

#B.  Table 1, Steps 1-2
Import the data into MSStatsTMT

```{r}


processed.features <- MSstatsTMT::PDtoMSstatsTMTFormat(pd_annotation$df,
                                                    pd_annotation$annotation,
                                                    which.proteinid = "Master.Protein.Accessions",
                                                    useNumProteinsColumn = FALSE,
                                                    useUniquePeptide = TRUE,
                                                    rmPSM_withfewMea_withinRun = TRUE,
                                                    rmProtein_with1Feature = TRUE,
                                                    summaryforMultipleRows = max,
                                                    use_log_file = FALSE,
                                                    append=FALSE,
                                                    verbose=TRUE)
```

### Table 1 Steps 4-6
Summarize the peptide data into proteins

```{r}

                                                   
summarised.proteins <- MSstatsTMT::proteinSummarization(data = processed.features,
                                method = "msstats",
                                global_norm = FALSE,
                                reference_norm = TRUE,
                                MBimpute=TRUE,
                                use_log_file=FALSE,
                                append=FALSE,
                                remove_norm_channel=FALSE,
                                remove_empty_channel=FALSE)

summarised.proteins$ProteinLevelData<-summarised.proteins$ProteinLevelData|>
  dplyr::inner_join(set_temps(10,c(37.3, 40.6, 43.9, 47.2, 50.5, 53.8, 57.1, 60.4, 64, 67)))|>
  dplyr::inner_join(pd_annotation$annotation|>
                      dplyr::select(Mixture,treatment)|>
                      dplyr::distinct())
```
#C.  Table 2
###  Create a matrix to measure the contrast using a subset of temperatures

    ```{r}
    df3<-list()
    #remove reference channel because there is no variability after protein normalization
    df3$ProteinLevelData<-summarised.proteins$ProteinLevelData


    #choose three ranges around the midpoint
        temps_late<-c("53.8","57.1","60.4")
        temps_mid<-c("50.5","53.8","57.1")
        temps_ear<-c("47.2", "50.5", "53.8")
        #then create a contrast matrix without the reference channel 
        comparison_late<-make_contrast_matrix(df3,temps=temps_late)
        comparison_mid<-make_contrast_matrix(df3,temps=temps_mid)
        comparison_ear<-make_contrast_matrix(df3,temps=temps_ear)
      
    ```

###  Fit linear mixed models with groupComparisons from MSstatsTMT

```{r}
DIM_late<-groupComparisonThermalProfiling(
  df3,
  contrast.matrix = comparison_late,
  moderated = FALSE,
  adj.method = "BH",
  remove_norm_channel = TRUE,
  remove_empty_channel = TRUE,
  save_fitted_models = TRUE,
  use_log_file = FALSE,
  append = FALSE,
  verbose = TRUE,
  log_file_path = NULL,
  missing_timepoint = "replace",
  replacement=list("131_vehicle" = c("130C_vehicle"))
)

DIM_mid<-groupComparisonThermalProfiling(
  df3,
  contrast.matrix = comparison_mid,
  moderated = FALSE,
  adj.method = "BH",
  remove_norm_channel = TRUE,
  remove_empty_channel = TRUE,
  save_fitted_models = TRUE,
  use_log_file = FALSE,
  append = FALSE,
  verbose = TRUE,
  log_file_path = NULL,
   missing_timepoint = "replace",
  replacement=list("131_vehicle" = c("130C_vehicle"))
)

DIM_ear<-groupComparisonThermalProfiling(
  df3,
  contrast.matrix = comparison_ear,
  moderated = FALSE,
  adj.method = "BH",
  remove_norm_channel = TRUE,
  remove_empty_channel = TRUE,
  save_fitted_models = TRUE,
  use_log_file = FALSE,
  append = FALSE,
  verbose = TRUE,
  log_file_path = NULL,
   missing_timepoint = "replace",
  replacement=list("131_vehicle" = c("130C_vehicle"))
)
```

### Fit models using filtered data which only considers the variance from the selected contrasts

```{r}
early_data<-list()
middle_data<-list()
later_data<-list()
comparison_early<-comparison_ear[which(!comparison_ear==0)]|>as.matrix()|>t()
colnames(comparison_early)<-colnames(comparison_ear)[which(!comparison_ear==0)]
rownames(comparison_early)<-"DIM"
early_data$ProteinLevelData<-df3$ProteinLevelData[df3$ProteinLevelData$Condition%in%colnames(comparison_early),]
comparison_middle<-comparison_mid[which(!comparison_mid==0)]|>as.matrix()|>t()
rownames(comparison_middle)<-"DIM"
colnames(comparison_middle)<-colnames(comparison_mid)[which(!comparison_mid==0)]
middle_data$ProteinLevelData<-df3$ProteinLevelData[df3$ProteinLevelData$Condition%in%colnames(comparison_middle),]
comparison_later<-comparison_late[which(!comparison_late==0)]|>as.matrix()|>t()
rownames(comparison_later)<-"DIM"
colnames(comparison_later)<-colnames(comparison_late)[which(!comparison_late==0)]
later_data$ProteinLevelData<-df3$ProteinLevelData[df3$ProteinLevelData$Condition%in%colnames(comparison_later),]

DIM_later<-MSstatsTMT::groupComparisonTMT(
later_data,
contrast.matrix = comparison_later,
moderated = FALSE,
adj.method = "BH",
remove_norm_channel = TRUE,
remove_empty_channel = TRUE,
save_fitted_models = TRUE,
use_log_file = FALSE,
append = FALSE,
verbose = TRUE,
log_file_path = NULL
)
DIM_middle<-MSstatsTMT::groupComparisonTMT(
middle_data,
contrast.matrix = comparison_middle,
moderated = FALSE,
adj.method = "BH",
remove_norm_channel = TRUE,
remove_empty_channel = TRUE,
save_fitted_models = TRUE,
use_log_file = FALSE,
append = FALSE,
verbose = TRUE,
log_file_path = NULL
)
DIM_early<-MSstatsTMT::groupComparisonTMT(
early_data,
contrast.matrix = comparison_early,
moderated = FALSE,
adj.method = "BH",
remove_norm_channel = TRUE,
remove_empty_channel = TRUE,
save_fitted_models = TRUE,
use_log_file = FALSE,
append = FALSE,
verbose = TRUE,
log_file_path = NULL
)
```

# Benchmarking with other statistical models

#D.  TPP sigmoid



```{r}

#since the MSstats protein summarization output does not have the temperature data, we need to perform an inner join to add this 
MSstatsproteins<-summarised.proteins$ProteinLevelData |> dplyr::mutate(Channel=as.character(Channel),Mixture=as.character(Mixture))|>
  as.data.frame()
#inner join annotation file to get back the subject column

reps<-pd_annotation$annotation|>
  dplyr::select(Mixture,Subject)|>
  dplyr::distinct()


MSstatsproteins<-MSstatsproteins|>
  as.data.frame()|>
  dplyr::inner_join(reps,by="Mixture")

proteins1<-MSstatsproteins|>dplyr::mutate(
shape=ifelse(temperature==min(temperature,na.rm=TRUE),"reference","included"))|>dplyr::distinct()
#Since MSstats outputs are log2 transformed, NPARC runs faster by ratioing the data from all temperatures over the baseline temperature

proteins1<-proteins1|>
  as.data.frame()|>
  dplyr::group_by(Protein,Run,Mixture)|>
  dplyr::group_split()
#unlog protein data
proteins1<-proteins1|>
  lapply(function(x) x|>
  dplyr::mutate(Abundance=2^Abundance))

proteins1<-lapply(proteins1,function(y) y|>as.data.frame()|>dplyr::mutate(Abundance=                                                      Abundance/Abundance[1]))|>dplyr::bind_rows()
#QC profile to check the boxplot of data
# ggplot(proteins1,mapping=aes(x=as.factor(temperature),y=Abundance))+geom_boxplot()+ylim(0,1)

# proteins1<-filter_good_data(proteins)
#Run TPP spline and implement the NPARC F-test with 5 DF
start=proc.time()
TPPtr_human_results = TPP_NPARC_calc(proteins1,method="TPP",DF=5,CARRIER=TRUE,temps=set_temps(10,c(37.3, 40.6, 43.9, 47.2, 50.5, 53.8, 57.1, 60.4, 64, 67)),NORM=FALSE,filters=TRUE)
end=proc.time()
print(end-start)
```

#E.  TPP splines

```{r}
start=proc.time()
TPP_human_results_F = TPP_NPARC_calc(proteins1,method="NPARC",DF=5,CARRIER=TRUE,temps=set_temps(10,c(37.3, 40.6, 43.9, 47.2, 50.5, 53.8, 57.1, 60.4, 64, 67)),NORM=FALSE,filters=TRUE)
end=proc.time()
print(end-start)
```

#F. NPARC

```{r}

#Then run NPARC
NPARC_human_fits <-NPARC::NPARCfit(x =proteins1$temperature,
                 y =proteins1$Abundance,
                 id =proteins1$Protein,
                 groupsNull = NULL,
                 groupsAlt = as.character(proteins1$treatment),
                 returnModels = TRUE)
```

###Empirical test

```{r}
NPARC_test_emp<-NPARC::NPARCtest(NPARC_human_fits$metrics,dfType="empirical")
NPARC_test_emp$id<-as.character(NPARC_test_emp$id)
hist(NPARC_test_emp$pVal)
```

###Theoretical test

```{r}
NPARC_test_theo<-NPARC::NPARCtest(NPARC_human_fits$metrics,dfType="theoretical")
hist(NPARC_test_theo$pVal)


```

#G.  SCAM Splines

```{r}

SCAM_Human_proteins<-MSstatstoSCAM(proteins1)
head(SCAM_Human_proteins)

```

```{r}
DIM_Human_SCAM<-compute_pvalues_ATE_RE_F(SCAM_Human_proteins)

```

##H. Figures 1 and 2 
###Panel C Row 1 

First calculate the total number of proteins from PD

```{r}
Total_prot<-list("TPP"=unique(df$Master.Protein.Accessions),"NPARC"=unique(df$Master.Protein.Accessions),"SCAM"=unique(df$Master.Protein.Accessions),"MSstatsTMT"=unique(df$Master.Protein.Accessions))
#remove shared accessions
Total_prot<-lapply(Total_prot,function(x) x[!stringr::str_detect(x,";")])
#remove missing values
Total_prot<-lapply(Total_prot,function(x) as.character(x)|>na.omit())

#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Total_prot,function(x) sum(as.character(x)%in%c("P36507","Q02750")))

Total_prot_n<-purrr::map2(Total_prot,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="PSMs (unique protein groups):\n from PD",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```

###Panel C row 2
Then after MSstatsTMT processing

```{r}
Output_proc<-list("TPP"=unique(summarised.proteins$ProteinLevelData$Protein),"NPARC"=unique(summarised.proteins$ProteinLevelData$Protein),"SCAM"=unique(summarised.proteins$ProteinLevelData$Protein),"MSstatsTMT"=unique(summarised.proteins$ProteinLevelData$Protein))
#remove shared accessions
Output_proc<-lapply(Output_proc,function(x) x[!stringr::str_detect(x,";")])
#remove missing values
Output_proc<-lapply(Output_proc,function(x) as.character(x)|>na.omit())

#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Output_proc,function(x) sum(x%in%c("P36507","Q02750")))

Output_proc_n<-purrr::map2(Output_proc,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: aggregated by \n MSstatsTMT (Table 1)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```

### Panel C row 3
Statistical model fit convergence

```{r}
Benchmarks_MSstatsTMTproc<-list("TPP"=unique(TPP_human_results_F$uniqueID[!is.na(TPP_human_results_F$p_adj_NPARC)]),"NPARC"=unique(NPARC_test_emp$id),"SCAM"=unique(DIM_Human_SCAM$Accession),"MSstatsTMT"=DIM_late$ComparisonResult$Protein[is.na(DIM_late$ComparisonResult$issue)])
#remove shared accessions
Benchmarks_MSstatsTMTproc<-lapply(Benchmarks_MSstatsTMTproc,function(x) x[!stringr::str_detect(x,";")])
#remove missing values
Benchmarks_MSstatsTMTproc<-lapply(Benchmarks_MSstatsTMTproc,function(x) x[!is.na(x)])
#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Benchmarks_MSstatsTMTproc,function(x) sum(x%in%c("P36507","Q02750")))

Benchmarks_MSstatsTMTproc_n<-purrr::map2(Benchmarks_MSstatsTMTproc,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: converged fit\n(Table 2, steps 1-3)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
### Panel C, row 4

For the proteins that passed R\^2 and plateau filters

```{r}
TPPtr_filters<-unique(TPPtr_human_results$Protein_ID[TPPtr_human_results$passed_filter_vehicle_1_vs_treated_1&TPPtr_human_results$passed_filter_vehicle_2_vs_treated_2])
#remove shared accessions
TPPtr_filters<-TPPtr_filters[!stringr::str_detect(TPPtr_filters,";")]
#remove missing values
TPPtr_filters<-TPPtr_filters|>na.omit()
Benchmarks_MSstatsTMTproc_filt<-purrr::map2(Benchmarks_MSstatsTMTproc,names(Benchmarks_MSstatsTMTproc),function(x,y) ifelse(y=="NPARC",sum(x %in% TPPtr_filters),sum(x%in%x)))

Benchmarks_MSstatsTMTproc_filt<-lapply(Benchmarks_MSstatsTMTproc_filt,function(x) as.character(x)|>na.omit())
#verify if targets are present in the filtered data
Benchmarks_MSstatsTMTproc_targ<-
  purrr::map2(Benchmarks_MSstatsTMTproc,names(Benchmarks_MSstatsTMTproc),function(x,y) ifelse(y=="NPARC",sum(x %in% TPPtr_filters& x%in%c("P36507","Q02750")),sum(x%in%c("P36507","Q02750"))))

Benchmarks_MSstatsTMTproc_filt_n<-purrr::map2(Benchmarks_MSstatsTMTproc_filt,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(x),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: after filtering \n(Table 2, steps 1-4)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
### Panel C row 5
For differential expressed proteins

```{r}

Benchmarks_MSstatsTMTproc_p<-list("TPP"=unique(TPP_human_results_F$uniqueID[which(TPP_human_results_F$p_adj_NPARC<0.05)]),"NPARC"=as.character(unique(NPARC_test_emp$id[which(NPARC_test_emp$pAdj<0.05&NPARC_test_emp$id %in% TPPtr_filters)])),"SCAM"=unique(DIM_Human_SCAM$Accession[DIM_Human_SCAM$ATE_padjBH<0.05]),"MSstatsTMT"=unique(DIM_late$ComparisonResult$Protein[DIM_late$ComparisonResult$adj.pvalue<0.05]))
#remove shared accessions
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) x[!stringr::str_detect(x,";")])
#remove missing values
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) as.character(x)|>na.omit())

Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) as.character(x)|>na.omit())
#verify if differentially abundant proteins are present in the filtered data
Benchmarks_MSstatsTMTproc_targ<-
  purrr::map2(Benchmarks_MSstatsTMTproc_p,names(Benchmarks_MSstatsTMTproc_p),function(x,y) ifelse(y=="NPARC",sum(x %in% TPPtr_filters&x%in%c("P36507","Q02750")),sum(x%in%c("P36507","Q02750"))))

Benchmarks_MSstatsTMTproc_p_n<-purrr::map2(Benchmarks_MSstatsTMTproc_p,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: differential abundance \n(Table 2, steps 1-5)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```

### Save R files
Save the proteins processed by MSstatsTMT

```{r}
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) as.character(x)|>na.omit())

names(Benchmarks_MSstatsTMTproc_p)<-c("TPP stat. model","NPARC stat. model","SCAM stat. model","MSstatsTMT stat. model")
Dataset_1_psm_results<-Benchmarks_MSstatsTMTproc_p
saveRDS(Dataset_1_psm_results,"Dataset_1_psm_results.RDS")
```
Append MSstatsTMT fitted models to the data

```{r}
targets<-proteins1|>
  as.data.frame()|>
  dplyr::filter(Protein%in% c("P36507","Q02750"))|>
  dplyr::mutate(Accession=Protein)|>
  dplyr::inner_join(Stat_mod)|>
  dplyr::group_by(Accession)|>
  dplyr::group_split()

DIM_targets<-DIM_late$FittedModel[which(names(DIM_late$FittedModel) %in% c("P36507","Q02750"))]
fitted_MSstat<-purrr::map2(targets,DIM_targets,function(x,y)x|>dplyr::mutate(model=list(y)))
```

#I.  Plot the curves Figure 1, panels E-H and save data

```{r}
targets<-MSstatsproteins|>
  as.data.frame()|>
  dplyr::filter(Protein%in% c("P36507","Q02750"))|>
  dplyr::mutate(Accession=Protein)|>
  dplyr::inner_join(Stat_mod)|>
  dplyr::group_by(Accession)|>
  dplyr::group_split()

DIM_targets<-DIM_late$FittedModel[which(names(DIM_late$FittedModel) %in% c("P36507","Q02750"))]
fitted_MSstat<-purrr::map2(targets,DIM_targets,function(x,y)x|>dplyr::mutate(model=list(y)))

nam<-as.character(unique(dplyr::bind_rows(targets)$Protein))
target_curves<-lapply(fitted_MSstat,function(x){plotMethods(x,temps=c("53.8","57.1","60.4"),labels=c("E","F","G","H"),processing="MSstatsTMT", fit="Spline")
})
names(target_curves)<-nam
#get path

path<-getwd()
target_curves$P36507
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Curves_MSstatsTMT_spline_P36507.tiff")

target_curves$Q02750
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Curves_MSstatsTMT_spline_Q02750.tiff")
```
#J. Figure 2, Panel C bar charts
Plot the bar charts

```{r}
bar_human<-dplyr::bind_rows(Total_prot_n,Output_proc_n,Benchmarks_MSstatsTMTproc_n,Benchmarks_MSstatsTMTproc_filt_n,Benchmarks_MSstatsTMTproc_p_n)

bar_human$Analysis<-factor(bar_human$Analysis,levels=c("TPP","NPARC","SCAM","MSstatsTMT"))

col<-data.frame(Analysis=factor(unique(bar_human$Analysis),levels=c("TPP","NPARC","SCAM","MSstatsTMT")),"stat_model"=c("#D95F0E","#FEC44F","#2C7FB8","#07fff8"))


bar_human<-bar_human|>dplyr::inner_join(col)

bar_human$Analysis<-factor(paste0("MSstatsTMT proc., ",bar_human$Analysis," model"),levels=c("MSstatsTMT proc., TPP model","MSstatsTMT proc., NPARC model","MSstatsTMT proc., SCAM model","MSstatsTMT proc., MSstatsTMT model"))

bar_human$Steps<-factor(bar_human$Steps,levels=c("Proteins: differential abundance \n(Table 2, steps 1-5)","Proteins: after filtering \n(Table 2, steps 1-4)","Proteins: converged fit\n(Table 2, steps 1-3)","Proteins: aggregated by \n MSstatsTMT (Table 1)","PSMs (unique protein groups):\n from PD"))


bar_human$Protein_targ<-paste0(bar_human$Proteins," ","(",bar_human$ver_targets,")")

bHuman<-ggplot2::ggplot(bar_human|>dplyr::group_by(Analysis),mapping=aes(x=Steps,y=as.integer(Proteins),alpha=Steps,fill=stat_model))+geom_col(stat_count=aes(x=Steps,y=Proteins),colour="black")+scale_y_continuous(limits=c(0,15000),breaks = c(0,6000,12000))+ylab("Number of proteins remaining after each step")+coord_flip()+facet_wrap(~Analysis,nrow=1, labeller = label_wrap_gen(width=20))+scale_fill_manual(values=c("#2C7FB8","#07fff8","#D95F0E","#FEC44F"))+xlab("Steps")+geom_text(aes(label=Protein_targ),size=8,position=position_dodge(width=0.5),hjust=-0.350,alpha=0.9)+theme(text=element_text(size=25,                          color = "black"),axis.text.x = element_text(size=25,face="bold"),axis.text.y=element_text(size=25,face="bold"),axis.title.x = element_text(size=25),axis.title.y=element_text(size=25),strip.text.x=element_text(size=25),legend.position="none", strip.placement = "outside")+geom_rect(data = subset(bar_human, Analysis %in% "MSstatsTMT proc., MSstatsTMT model"), 
                          fill = NA, colour = "green", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf,size=2)

path = getwd()
bHuman
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Bar_chartsmid_MSstatsTMT.tiff")

```

### Venn Diagrams (all methods)

```{r}

Venn_Humandata<-ggvenn::ggvenn(data=Benchmarks_MSstatsTMTproc_p,fill_color =c("#D95F0E","#FEC44F","#07fff8", "#2C7FB8"),set_name_size=4,stroke_alpha=2,text_size=4,fill_alpha = 0.6,show_percentage = FALSE)+ggtitle("pAdj < 0.05")+theme(text=element_text(size=20))
Venn_Humandata
```
#K. Figure 2, Panel D Venn Diagrams (top 3)

```{r}
png(filename = "Venn_Humandata_MSstatmid.png",
    width =12, height = 6, units = "in", pointsize = 12,
    res = 600,type ="cairo")  

library(ggvenn)
Venn_top3<-ggvenn::ggvenn(data=Benchmarks_MSstatsTMTproc_p[c(1,2,4)],fill_color =c("#D95F0E","#FEC44F","#2C7FB8"),set_name_size=5,text_size=8,stroke_size=1.5,fill_alpha = 0.6,show_percentage = FALSE)+ggtitle("MSstatsTMT processed pAdj < 0.05")+theme(text=element_text(size=20))
Venn_top3
dev.off() 

```

Filter expected targets from each result

```{r}
if(length(Benchmarks_MSstatsTMTproc_p$`NPARC stat. model`)==0){
  NPARC_human<-data.frame(id=rep(NA,2),pAdj=rep(1,2))
}else{
  NPARC_human<-NPARC_test_emp|>dplyr::filter(id %in% c("P36507","Q02750"))
}
TPP_human<-TPP_human_results_F|>dplyr::filter(uniqueID %in% c("P36507","Q02750"))

SCAM_human<-DIM_Human_SCAM|>dplyr::select(Accession,ATE_padjBH,p.value)|>dplyr::distinct()|>dplyr::filter(Accession %in% c("P36507","Q02750"))

MSstat_human<-DIM_late$ComparisonResult|>dplyr::filter(Protein%in%c("P36507","Q02750"))


Stat_mod<-data.frame(Protein=MSstat_human$Protein,NPARC_adjpval=formatC(NPARC_human$pAdj, format = "e", digits = 2),TPP_adjpval=formatC(TPP_human$p_adj_NPARC,format = "e", digits = 2),SCAM_adjpval=NA,MSstats_adjpval=formatC(MSstat_human$adj.pvalue,format = "e", digits = 2))



```

#L. Figure 2, panel E
##Compare Venn Diagrams between processing

```{r}

MSstatsTMT_proc<-lapply(Dataset_1_psm_results
                        ,function(x) as.character(x)|>na.omit())

TPP_proc<-lapply(Dataset_1_protein_results,function(x) as.character(x)|>na.omit())


compare_proc<-purrr::map2(TPP_proc,MSstatsTMT_proc,function(x,y) list("MSstatsTMT proc."=y,"TPP proc."=x))


colors<-list(TPP=c("#D95F0E","#D95F0E"),NPARC=c("#FEC44F","#FEC44F"),SCAM=c("#07fff8","#07fff8"),MSstatsTMT=c("#2C7FB8","#2C7FB8"))

colors<-purrr::set_names(colors,names(colors))
purrr::map2(compare_proc[1],colors[1],function(x,y)VennDiagram::venn.diagram(
  x = x,
  category.names =names(x),
  filename = paste0('Venn_Dataset_1_processing ',paste("TPP")),
  output = TRUE ,
  imagetype="png" ,
  height = 480 , 
  width = 480 , 
  resolution = 600,
  compression = "lzw",
  lwd = 1,
  col=y,
  cex=0.5,
  cat.cex=0.3,
  rotation.degree=90,
     cat.pos = c(180,0),
          cat.dist = c(0.02, 0.02),
  scaled=FALSE,
  inverted=FALSE
  
))
  

purrr::map2(compare_proc[2],colors[2],function(x,y)VennDiagram::venn.diagram(
  x = x,
  category.names =names(x),
  filename = paste0('Venn_Dataset_1_processing ',paste("NPARC")),
  output = TRUE ,
  imagetype="png" ,
  height = 480 , 
  width = 480 , 
  resolution = 600,
  compression = "lzw",
  lwd = 1,
  col=y,
  cex=0.5,
  cat.cex=0.3,
  rotation.degree=-90,
    cat.pos = c(180,0),
    cat.dist = c(0.02, 0.02),
  scaled=FALSE,
  inverted=FALSE
  
))


purrr::map2(compare_proc[3],colors[3],function(x,y)VennDiagram::venn.diagram(
  x = x,
  category.names =names(x),
  filename = paste0('Venn_Dataset_1_processing ',paste("SCAM")),
  output = TRUE ,
  imagetype="png" ,
  height = 480 , 
  width = 480 , 
  resolution = 600,
  compression = "lzw",
  lwd = 1,
  col=y,
  cex=0.5,
  cat.cex=0.3,
  rotation.degree=90,
    cat.pos = c(180,0),
    cat.dist = c(0.02, 0.02),
  scaled=FALSE,
  inverted=FALSE
  
))

purrr::map2(compare_proc[4],colors[4],function(x,y)VennDiagram::venn.diagram(
  x = x,
  category.names =names(x),
  filename = paste0('Venn_Dataset_1_processing ',paste("MSstatsTMT")),
  output = TRUE ,
  imagetype="png" ,
  height = 480 , 
  width = 480 , 
  resolution = 600,
  compression = "lzw",
  lwd = 1,
  col=y,
  cex=0.5,
  cat.cex=0.3,
  rotation.degree=90,
     cat.pos = c(180,0),
          cat.dist = c(0.02, 0.02),
  scaled=FALSE,
  inverted=FALSE
  
))
```
