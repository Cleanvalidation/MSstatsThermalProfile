------------------------------------------------------------------------
title: "Vignette 6"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data_Processing_MSstatsTMT}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
#With dataset 3a, this vignette will outline MSstatsTMT processed datasets at the peptide level and evaluate TPP spline, NPARC sigmoid, SCAM splines and MSstatsTMT statistical modeling.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include=TRUE}
devtools::load_all(".")

```

Library setup

```{r setup}
library(tidyr)
library(stringr)
library(TPP)
library(NPARC)
library(dplyr)
library(ggplot2)
library(ggrepel)
theme_set(theme_bw())

```

#A. Data Import

### Import option 1: Read in your own file

**Use getwd(your_working_directory) to get a folder where your PSM data is stored**

```{r}
WD<-"~/work/ivanovlab/figueroa-navedo.a/OnePot_dataset/Reprocessed/"
h<-list.files(WD,pattern="PSMs.txt")|>as.list()
setwd(WD)
df<-purrr::map(h,function(x) read.delim(x)) |> dplyr::bind_rows()

PSMs<-df
df<-as.data.frame(df)
#Filter out shared accessions
#df<-df[!stringr::str_detect(df$`Master Protein Accessions`,";"),]
#Filter out channel 131C
df<-df[,!stringr::str_detect(names(df),"Abundance.131C")]
#rename 131C to 131
names(df)<-stringr::str_replace(names(df),"131N","131")
```

Annotation File Generation

### Option 1: Generate annotation file

```{r}
# 
# 
PD_df<-df|>dplyr::select(Spectrum.File,File.ID,dplyr::starts_with("Abundance"))|>dplyr::mutate(Fraction=stringr::str_remove(File.ID,"F[:digit:]."))|>dplyr::mutate(treatment=ifelse(stringr::str_detect(Spectrum.File,"V|DMSO"),"vehicle","treated"))


PD_df<-PD_df|>tidyr::pivot_longer(cols=colnames(PD_df)[stringr::str_detect(colnames(PD_df),"Abundance")],names_to="Channel",values_to="Abundance")|>dplyr::select(-Abundance)|>dplyr::distinct()|>dplyr::mutate(Channel=stringr::str_extract(Channel,"[[:digit:]]+[N|C]|[:digit:][:digit:][:digit:]"),File.ID=stringr::str_extract(File.ID,"F[:digit:]"),Condition=paste0(Channel,"_",treatment))

Mapping<-PD_df|>dplyr::select(treatment,File.ID)|>dplyr::distinct()|>dplyr::group_by(treatment)|>dplyr::mutate(TechRepMixture=seq(1:dplyr::n()))|>dplyr::ungroup()
# #set mapping between temperatures and channels
temps<-set_temps(10,c("37.3","40.2","44.9","47.6","51","54","57","61.8","64.1","67"))
#TMT11 was used but the 75C temperature was filtered out
# temps$Channel<-ifelse(temps$Channel=="131","131C",temps$Channel)
#add temperatures
df_annotation<-PD_df|>dplyr::select(Spectrum.File,Channel,File.ID,Fraction,Condition)|>dplyr::distinct()|>dplyr::inner_join(temps,by="Channel")|>dplyr::inner_join(Mapping)

#Add bioreplicate
df_annotation$BioReplicate<-ifelse(df_annotation$temperature==min(df_annotation$temperature),"Norm",paste0(df_annotation$Channel,"_",df_annotation$treatment))

df_annotation$Mixture<-paste0(df_annotation$treatment,"_",
                                           df_annotation$TechRepMixture)
df_annotation$Run<-df_annotation$Spectrum.File



```



#B. Table 1, steps 1 and 2 
Import the data into MSStatsTMT

```{r}

processed.features <- MSstatsTMT::PDtoMSstatsTMTFormat(df,
                                                    df_annotation,
                                                    which.proteinid = "Master.Protein.Accessions",
                                                    useNumProteinsColumn = FALSE,
                                                    useUniquePeptide = TRUE,
                                                    rmPSM_withfewMea_withinRun = TRUE,
                                                    rmProtein_with1Feature = TRUE,
                                                    summaryforMultipleRows = max,
                                                    use_log_file = FALSE,
                                                    append=FALSE,
                                                    verbose=TRUE)
```
### Table 1 steps 4-6
Summarize the peptide data into proteins

```{r}
processed.features$Condition<-as.character(processed.features$Condition)
processed.features$Condition[stringr::str_detect(processed.features$Condition,"126")]<-"Norm"

summarised.proteins <- MSstatsTMT::proteinSummarization(
  data = processed.features,
  method = "msstats",
  global_norm = FALSE,
  reference_norm = TRUE,
  MBimpute=TRUE,
  use_log_file=FALSE,
  append=FALSE,
  remove_norm_channel=TRUE,
  remove_empty_channel=TRUE)

summarised.proteins$ProteinLevelData<-summarised.proteins$ProteinLevelData|>dplyr::inner_join(temps,by="Channel")
summarised.proteins$FeatureLevelData<-summarised.proteins$FeatureLevelData|>dplyr::inner_join(temps,by="Channel")
summarised.proteins$ProteinLevelData$treatment<-summarised.proteins$ProteinLevelData$Run
summarised.proteins$FeatureLevelData$treatment<-summarised.proteins$FeatureLevelData$Run
```
#C. Table 2

###  Create a matrix to measure the contrast using a subset of temperatures

    ```{r}
    df3<-list()
    #copy summarised data to a separate list_df
    df3$ProteinLevelData<-summarised.proteins$ProteinLevelData
    df3$FeatureLevelData<-summarised.proteins$FeatureLevelData

    #choose three temps to contrast around the midpoint
        temps_late<-c("54","57","61.8")
        temps_mid<-c("47.6","51","54")
        temps_ear<-c("40.2","47.6","51")
        #then create a contrast matrix without the reference channel 
        comparison_late<-make_contrast_matrix(df3,temps=temps_late)
        comparison_mid<-make_contrast_matrix(df3,temps=temps_mid)
        comparison_ear<-make_contrast_matrix(df3,temps=temps_ear)
      
    ```

#D. As in Figure 5, panel E Fit models using filtered data which only considers the variance from the selected contrasts
```{r}
early_data<-list()
middle_data<-list()
later_data<-list()
comparison_early<-comparison_ear[which(!comparison_ear==0)]|>as.matrix()|>t()
colnames(comparison_early)<-colnames(comparison_ear)[which(!comparison_ear==0)]
rownames(comparison_early)<-"DIM"
early_data$ProteinLevelData<-df3$ProteinLevelData[df3$ProteinLevelData$Condition%in%colnames(comparison_early),]
comparison_middle<-comparison_mid[which(!comparison_mid==0)]|>as.matrix()|>t()
rownames(comparison_middle)<-"DIM"
colnames(comparison_middle)<-colnames(comparison_mid)[which(!comparison_mid==0)]
middle_data$ProteinLevelData<-df3$ProteinLevelData[df3$ProteinLevelData$Condition%in%colnames(comparison_middle),]
comparison_later<-comparison_late[which(!comparison_late==0)]|>as.matrix()|>t()
rownames(comparison_later)<-"DIM"
colnames(comparison_later)<-colnames(comparison_late)[which(!comparison_late==0)]
later_data$ProteinLevelData<-df3$ProteinLevelData[df3$ProteinLevelData$Condition%in%colnames(comparison_later),]

DIM_later<-MSstatsTMT::groupComparisonTMT(
later_data,
contrast.matrix = comparison_later,
moderated = FALSE,
adj.method = "BH",
remove_norm_channel = TRUE,
remove_empty_channel = TRUE,
save_fitted_models = TRUE,
use_log_file = FALSE,
append = FALSE,
verbose = TRUE,
log_file_path = NULL
)
DIM_middle<-MSstatsTMT::groupComparisonTMT(
middle_data,
contrast.matrix = comparison_middle,
moderated = FALSE,
adj.method = "BH",
remove_norm_channel = TRUE,
remove_empty_channel = TRUE,
save_fitted_models = TRUE,
use_log_file = FALSE,
append = FALSE,
verbose = TRUE,
log_file_path = NULL
)
DIM_early<-MSstatsTMT::groupComparisonTMT(
early_data,
contrast.matrix = comparison_early,
moderated = FALSE,
adj.method = "BH",
remove_norm_channel = TRUE,
remove_empty_channel = TRUE,
save_fitted_models = TRUE,
use_log_file = FALSE,
append = FALSE,
verbose = TRUE,
log_file_path = NULL
)
```

#E. As in Figure 5, panel F to fit linear mixed models with groupComparisons from MSstatsTMT

```{r}
DIM_late<-groupComparisonThermalProfiling(
  df3,
  contrast.matrix = comparison_late,
  moderated = FALSE,
  adj.method = "BH",
  remove_norm_channel = TRUE,
  remove_empty_channel = TRUE,
  save_fitted_models = TRUE,
  use_log_file = FALSE,
  append = FALSE,
  verbose = TRUE,
  log_file_path = NULL,
  missing_timepoint = "replace",
  replacement=list("131_vehicle" = c("130C_vehicle"))
)

DIM_mid<-groupComparisonThermalProfiling(
  df3,
  contrast.matrix = comparison_mid,
  moderated = FALSE,
  adj.method = "BH",
  remove_norm_channel = TRUE,
  remove_empty_channel = TRUE,
  save_fitted_models = TRUE,
  use_log_file = FALSE,
  append = FALSE,
  verbose = TRUE,
  log_file_path = NULL,
   missing_timepoint = "replace",
  replacement=list("131_vehicle" = c("130C_vehicle"))
)

DIM_ear<-groupComparisonThermalProfiling(
  df3,
  contrast.matrix = comparison_ear,
  moderated = FALSE,
  adj.method = "BH",
  remove_norm_channel = TRUE,
  remove_empty_channel = TRUE,
  save_fitted_models = TRUE,
  use_log_file = FALSE,
  append = FALSE,
  verbose = TRUE,
  log_file_path = NULL,
   missing_timepoint = "replace",
  replacement=list("131_vehicle" = c("130C_vehicle"))
)
```

# Benchmarking

#F. TPP sigmoid

We start by using the traditional TPP method

```{r}

#since the MSstats protein summarization output does not have the temperature data, we need to perform an inner join to add this 
proteins<-summarised.proteins$ProteinLevelData |> dplyr::mutate(Channel=as.character(Channel),Mixture=as.character(Mixture))|>as.data.frame()
#inner join annotation file to get back the subject column
reps<-df_annotation|>dplyr::mutate(Subject=Mixture)|>dplyr::select(Mixture,Subject)|>dplyr::distinct()

proteins<-proteins|>
  as.data.frame()|>
  dplyr::inner_join(reps)

proteins1<-proteins|>dplyr::mutate(Condition=stringr::str_extract(Condition,"[[:lower:]]+"),
shape=ifelse(temperature==min(temperature,na.rm=TRUE),"reference","included"))|>dplyr::distinct()
#Since MSstats outputs are log2 transformed, NPARC runs faster by ratioing the data from all temperatures over the baseline temperature

if(length(unique(proteins1$Condition))>2|length(unique(proteins1$Condition)==1)){
  
  proteins1$Condition<-ifelse(stringr::str_detect(stringr::str_extract(stringr::str_remove_all(stringr::str_to_lower(proteins1$Run),"[[:digit:]]+&[[:punct:]]+"),"[[:lower:]]+"),"dmso|v"),"vehicle","treated")
}

proteins1<-proteins1|>
  as.data.frame()|>
  dplyr::group_by(Protein,Run,Mixture)|>
  dplyr::group_split()|>
  lapply(function(x) x|>
  dplyr::mutate(Abundance=2^Abundance))

proteins1<-lapply(proteins1,function(y) y|>as.data.frame()|>dplyr::mutate(Abundance=                                                      Abundance/Abundance[1]))|>dplyr::bind_rows()

 proteins1$temperature<-as.integer(proteins1$temperature)
 proteins1$treatment<-proteins1$Condition
#QC profile to check the boxplot of data
# ggplot(proteins1,mapping=aes(x=as.factor(temperature),y=Abundance))+geom_boxplot()+ylim(0,1)

#Run TPP spline and implement the NPARC F-test with 5 DF
start=proc.time()
TPPtr_human_results = TPP_NPARC_calc(proteins1,method="TPP",DF=5,CARRIER=FALSE,temps=set_temps(10,c(37.3, 40.6, 43.9, 47.2, 50.5, 53.8, 57.1, 60.4, 64, 67)),NORM=FALSE,filters=TRUE,pipeline=TRUE)
end=proc.time()
print(end-start)


```

#G. TPP splines

```{r}
start=proc.time()
TPP_human_results_F = TPP_NPARC_calc(proteins1,method="NPARC",DF=5,CARRIER=FALSE,temps=set_temps(10,c(37.3, 40.6, 43.9, 47.2, 50.5, 53.8, 57.1, 60.4, 64, 67)),NORM=FALSE,filters=TRUE)
end=proc.time()
print(end-start)
```

#H. NPARC

```{r}

#Then run NPARC
NPARC_human_fits <-NPARC::NPARCfit(x =proteins1$temperature,
                 y =proteins1$Abundance,
                 id =proteins1$Protein,
                 groupsNull = NULL,
                 groupsAlt = as.character(proteins1$treatment),
                 returnModels = TRUE)
```

### Empirical test

```{r}
NPARC_test_emp<-NPARC::NPARCtest(NPARC_human_fits$metrics,dfType="empirical")
hist(NPARC_test_emp$pVal)
```

### Theoretical test

```{r}
NPARC_test_theo<-NPARC::NPARCtest(NPARC_human_fits$metrics,dfType="theoretical")
hist(NPARC_test_theo$pVal)


```

#I. SCAM Splines

```{r}

SCAM_Human_proteins<-MSstatstoSCAM(proteins1)
head(SCAM_Human_proteins)
DIM_Human_SCAM<-compute_pvalues_ATE_RE_F(SCAM_Human_proteins)

```

### Determine which accessions are kinase targets

```{r}
#read in protein file
WD<-"~/work/ivanovlab/figueroa-navedo.a/OnePot_dataset/CETSA_onePot/OnePot/"
h<-list.files(WD,pattern="Proteins.xlsx")|>as.list()
setwd(WD)
Proteins<-data.frame()
Proteins<-lapply(h,function(x) readxl::read_xlsx(paste0(WD,x))) |> dplyr::bind_rows()|>dplyr::select(Accession,"Gene Symbol")|>dplyr::rename("GeneSymbol"="Gene Symbol")|>dplyr::distinct()
#Read in human kinome (522 proteins)
kinases<-read.csv(paste0(WD,"/HumanKinome_040920.csv"))
kinases<-kinases$Accession

#join Uniprot IDs to original DF
kinase_df<-kinases|>dplyr::inner_join(Proteins,relationship="many-to-many")|>dplyr::distinct()
```

# J. Figures 3, S-17 S-19 and S-21
###Panel C, row 1
For the total number of proteins

```{r}
#remove shared proteins
PSMs<-PSMs[!stringr::str_detect(PSMs$Master.Protein.Accessions,";"),]

Total_prot<-list("TPP"=unique(PSMs$Master.Protein.Accessions),"NPARC"=unique(PSMs$Master.Protein.Accessions),"SCAM"=unique(PSMs$Master.Protein.Accessions),"MSstatsTMT"=unique(PSMs$Master.Protein.Accessions))
#remove shared accessions
Total_prot<-lapply(Total_prot,function(x) {
  y<-x[!stringr::str_detect(x,";")]
  y<-unique(stringr::str_remove(y,"-[:digit:]"))
  print(paste0(length(y)," out of ",length(x)," proteins have unique protein groups"))
  return(y)})
#remove missing values
Total_prot<-lapply(Total_prot,function(x) as.character(x)|>na.omit())

#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Total_prot,function(x) sum(as.character(x)%in%kinases))

Total_prot_n<-purrr::map2(Total_prot,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="PSMs (unique protein groups):\n from PD",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
###Panel C, row 2
Then after MSstatsTMT processing

```{r}
#remove shared proteins
summarised.proteins$ProteinLevelData<-summarised.proteins$ProteinLevelData[!stringr::str_detect(summarised.proteins$ProteinLevelData$Protein,";"),]

Output_proc<-list("TPP"=unique(summarised.proteins$ProteinLevelData$Protein),"NPARC"=unique(summarised.proteins$ProteinLevelData$Protein),"SCAM"=unique(summarised.proteins$ProteinLevelData$Protein),"MSstatsTMT"=unique(summarised.proteins$ProteinLevelData$Protein))
#remove shared accessions
Output_proc<-lapply(Output_proc,function(x) {y<-x[!stringr::str_detect(x,";")]
                    y<-unique(stringr::str_remove(y,"-[:digit:]"))
                    return(y)})
#remove missing values
Output_proc<-lapply(Output_proc,function(x) as.character(x)|>na.omit())

#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Output_proc,function(x) sum(x%in%kinases))

Output_proc_n<-purrr::map2(Output_proc,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: aggregated by \n MSstatsTMT (Table 1)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
###Panel C, row 3
Statistical model fit convergence

```{r}
Benchmarks_MSstatsTMTproc<-list("TPP"=unique(TPP_human_results_F$uniqueID[!is.na(TPP_human_results_F$p_adj_NPARC)]),"NPARC"=unique(NPARC_test_emp$id[!is.na(NPARC_test_emp$pAdj)]),"SCAM"=unique(DIM_Human_SCAM$Accession),"MSstatsTMT"=unique(DIM_late$ComparisonResult$Protein[is.na(DIM_late$ComparisonResult$issue)]))
#remove shared accessions
Benchmarks_MSstatsTMTproc<-lapply(Benchmarks_MSstatsTMTproc,function(x) x[!stringr::str_detect(x,";")])
#remove missing values
Benchmarks_MSstatsTMTproc<-lapply(Benchmarks_MSstatsTMTproc,function(x) as.character(x)|>na.omit())

Benchmarks_MSstatsTMTproc<-purrr::map2(Benchmarks_MSstatsTMTproc,Output_proc,function(x,y)y[y %in% x])
#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Benchmarks_MSstatsTMTproc,function(x) sum(x%in%kinases))

Benchmarks_MSstatsTMTproc_n<-purrr::map2(Benchmarks_MSstatsTMTproc,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: converged fit\n(Table 2, steps 1-3)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
###Panel C, row 3
For the proteins that passed R\^2 and plateau filters

```{r}
TPPtr_filters<-unique(TPPtr_human_results$Protein_ID[TPPtr_human_results$passed_filter_Vehicle_1_vs_Treatment_1&TPPtr_human_results$passed_filter_Vehicle_2_vs_Treatment_2])

#remove shared accessions
TPPtr_filters<-TPPtr_filters[!stringr::str_detect(TPPtr_filters,";")]
#remove missing values
TPPtr_filters<-TPPtr_filters|>na.omit()


Benchmarks_MSstatsTMTproc_filt<-purrr::map2(Benchmarks_MSstatsTMTproc,names(Benchmarks_MSstatsTMTproc),function(x,y) ifelse(y=="NPARC",sum(x %in% TPPtr_filters),sum(x%in%x)))

Benchmarks_MSstatsTMTproc_filt<-lapply(Benchmarks_MSstatsTMTproc_filt,function(x) as.character(x)|>na.omit())
#verify if targets are present in the filtered data
Benchmarks_MSstatsTMTproc_targ<-
  purrr::map2(Benchmarks_MSstatsTMTproc,names(Benchmarks_MSstatsTMTproc),function(x,y) ifelse(y=="NPARC",sum(x %in% TPPtr_filters& x%in%kinases),sum(x%in%kinases)))

Benchmarks_MSstatsTMTproc_filt_n<-purrr::map2(Benchmarks_MSstatsTMTproc_filt,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(x),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: after filtering \n(Table 2, steps 1-4)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
###Panel C, row 5
For differentially expressed proteins

```{r}
Benchmarks_MSstatsTMTproc_p<-list("TPP"=unique(TPP_human_results_F$uniqueID[TPP_human_results_F$p_adj_NPARC<0.05&TPP_human_results_F$uniqueID%in%TPPtr_filters]),"NPARC"=unique(as.character(NPARC_test_emp$id)[NPARC_test_emp$pAdj<0.05&NPARC_test_emp$id %in% TPPtr_filters]),"SCAM"=unique(DIM_Human_SCAM$Accession[DIM_Human_SCAM$ATE_padjBH<0.05]),"MSstatsTMT"=unique(DIM_late$ComparisonResult$Protein[DIM_late$ComparisonResult$adj.pvalue<0.05]))
#remove shared accessions
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) x[!stringr::str_detect(x,";")])
#remove missing values
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) as.character(x)|>na.omit())

#verify if differentially abundant proteins are present in the filtered data
Benchmarks_MSstatsTMTproc_targ<-
  purrr::map2(Benchmarks_MSstatsTMTproc_p,names(Benchmarks_MSstatsTMTproc_p),function(x,y) ifelse(y=="NPARC"|y=="TPP",sum(x %in% TPPtr_filters&x%in%kinases),sum(x%in%kinases)))

Benchmarks_MSstatsTMTproc_p_n<-purrr::map2(Benchmarks_MSstatsTMTproc_p,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: differential abundance \n(Table 2, steps 1-5)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
##Save R files

```{r}
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) as.character(x)|>na.omit())

names(Benchmarks_MSstatsTMTproc_p)<-c("TPP stat. model","NPARC stat. model","SCAM stat. model","MSstatsTMT stat. model")
Human_MSstatsTMTprocesed<-Benchmarks_MSstatsTMTproc_p
saveRDS(Human_MSstatsTMTprocesed,"Thermal_late_MSstatsTMTprocesed.RDS")
```
##Keep kinase interactors from each result

```{r}
NPARC_human<-NPARC_test_emp|>dplyr::filter(id %in% kinases)|>dplyr::mutate(Protein=id)

TPP_human<-TPP_human_results_F|>dplyr::filter(uniqueID %in% kinases)|>dplyr::mutate(Protein=uniqueID)

SCAM_human<-DIM_Human_SCAM|>dplyr::filter(Accession %in% kinases)|>dplyr::mutate(Protein=Accession)

MSstat_human<-DIM_late$ComparisonResult|>dplyr::filter(Protein%in%kinases)

Stat_mod<-proteins|>as.data.frame()|>dplyr::filter(Protein%in% c("P36507","Q02750","Q13188","O14757"))|>dplyr::mutate(Accession=Protein)|>dplyr::left_join(TPP_human)|>dplyr::left_join(NPARC_human|>dplyr::select(-df1,-df2))|>dplyr::left_join(SCAM_human)|>dplyr::left_join(MSstat_human)|>dplyr::group_by(Accession)|>dplyr::mutate(NPARC_adjpval=formatC(pAdj, format = "e", digits = 2),TPP_adjpval=formatC(p_adj_NPARC,format = "e", digits = 2),SCAM_adjpval=formatC(ATE_padjBH,format = "e", digits = 2),MSstats_adjpval=formatC(adj.pvalue,format = "e", digits = 2))|>dplyr::group_split()




```

##Append MSstatsTMT fitted models to the data

```{r}


DIM_targets<-DIM_late$FittedModel[which(names(DIM_late$FittedModel) %in% c("P36507","Q02750","Q13188","O14757"))]
fitted_MSstat<-purrr::map2(Stat_mod,DIM_targets,function(x,y)x|>dplyr::mutate(model=list(y)))|>dplyr::bind_rows()
```

# Plot the curves For Figures S-17 S-19 S-21 and save the data

```{r}
targets<-fitted_MSstat|>dplyr::group_by(Protein)|>dplyr::group_split()

nam<-as.character(unique(dplyr::bind_rows(fitted_MSstat)$Protein))
target_curves<-lapply(targets,function(x){tryCatch(plotMethods(x,temps=c("54","57","61.8"),labels=c("E","F","G","H"),processing="MSstatsTMT",fit="Spline"))
})
names(target_curves)<-nam

#set path
path<-getwd()

target_curves$P36507
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Curves_MSstatsTMT_Spline_P36507.tiff")

target_curves$Q02750
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Curves_MSstatsTMT_Spline_Q02750.tiff")

target_curves$Q13188
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Curves_MSstatsTMT_Spline_Q13188.tiff")

target_curves$O14757
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Curves_MSstatsTMT_Spline_O14757.tiff")
```

#K. Figure 3, panel C bar charts

```{r}
bar_human<-dplyr::bind_rows(Total_prot_n,Output_proc_n,Benchmarks_MSstatsTMTproc_n,Benchmarks_MSstatsTMTproc_filt_n,Benchmarks_MSstatsTMTproc_p_n)

bar_human$Analysis<-factor(bar_human$Analysis,levels=c("TPP","NPARC","SCAM","MSstatsTMT"))

col<-data.frame(Analysis=factor(unique(bar_human$Analysis),levels=c("TPP","NPARC","SCAM","MSstatsTMT")),"stat_model"=c("#D95F0E","#FEC44F","#2C7FB8","#07fff8"))


bar_human<-bar_human|>dplyr::inner_join(col)

bar_human$Analysis<-factor(paste0("MSstatsTMT proc., ",bar_human$Analysis," model"),levels=c("MSstatsTMT proc., TPP model","MSstatsTMT proc., NPARC model","MSstatsTMT proc., SCAM model","MSstatsTMT proc., MSstatsTMT model"))

bar_human$Steps<-factor(bar_human$Steps,levels=c("Proteins: differential abundance \n(Table 2, steps 1-5)","Proteins: after filtering \n(Table 2, steps 1-4)","Proteins: converged fit\n(Table 2, steps 1-3)","Proteins: aggregated by \n MSstatsTMT (Table 1)","PSMs (unique protein groups):\n from PD"))


bar_human$Protein_targ<-paste0(bar_human$Proteins," ","(",bar_human$ver_targets,")")

bHuman<-ggplot(bar_human|>dplyr::group_by(Analysis),mapping=aes(x=Steps,y=as.integer(Proteins),alpha=Steps,fill=stat_model))+geom_col(stat_count=aes(x=Steps,y=Proteins),colour="black")+scale_y_continuous(limits=c(0,22000),breaks = c(0,10000,20000))+ylab("Number of proteins remaining after each step")+coord_flip()+facet_wrap(~Analysis,nrow=1, labeller = label_wrap_gen(width=20))+scale_fill_manual(values=c("#2C7FB8","#07fff8","#D95F0E","#FEC44F"))+xlab("Steps")+geom_text(aes(label=Protein_targ),size=8,position=position_dodge(width=0.5),hjust=-0.350,alpha=0.9)+theme(text=element_text(size=25,                          color = "black"),axis.text.x = element_text(size=25,face="bold"),axis.text.y=element_text(size=25,face="bold"),axis.title.x = element_text(size=25),axis.title.y=element_text(size=25),strip.text.x=element_text(size=25),legend.position="none", strip.placement = "outside")+geom_rect(data = subset(bar_human, Analysis %in% "MSstatsTMT proc., MSstatsTMT model"), 
                          fill = NA, colour = "green", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf,size=2)
path = getwd()
bHuman
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Bar_charts_MSstatsTMT.tiff")
```


### Venn Diagrams

```{r}


Venn_Humandata<-ggvenn::ggvenn(data=Benchmarks_MSstatsTMTproc_p,fill_color =c("#FEC44F","#D95F0E","#07fff8", "#2C7FB8"),set_name_size=4,stroke_alpha=2,text_size=4,fill_alpha = 0.6,show_percentage = FALSE)+ggtitle("pAdj < 0.05")+theme(text=element_text(size=20))
Venn_Humandata
```

#L.Figure S-24, panel D Venn Diagrams (top 3)

```{r}
png(filename = "Venn_thermaldatalate_spline_MSstat.png",
    width =600, height = 600, units = "px", pointsize = 12,
    res = 130,type ="cairo")  

library(ggvenn)
ggvenn::ggvenn(data=Benchmarks_MSstatsTMTproc_p[c(1,2,4)],fill_color =c("#D95F0E","#FEC44F","#2C7FB8"),set_name_size=5,text_size=8,stroke_size=1.5,fill_alpha = 0.6,show_percentage = FALSE)+ggtitle("MSstatsTMT processed pAdj < 0.05")+theme(text=element_text(size=20))

dev.off() 

```
#M. Figure S-24, panel E
Compare Venn Diagrams between processing

```{r}

MSstatsTMT_proc<-lapply(Thermal_late_MSstatsTMTprocesed
                        ,function(x) as.character(x)|>na.omit())

TPP_proc<-lapply(Thermallate_spline_TPPprocesed,function(x) as.character(x)|>na.omit())


compare_proc<-purrr::map2(TPP_proc,MSstatsTMT_proc,function(x,y) list("MSstatsTMT proc."=y,"TPP proc."=x))


colors<-list(TPP=c("#D95F0E","#D95F0E"),NPARC=c("#FEC44F","#FEC44F"),SCAM=c("#07fff8","#07fff8"),MSstatsTMT=c("#2C7FB8","#2C7FB8"))

colors<-purrr::set_names(colors,names(colors))
purrr::map2(compare_proc[1],colors[1],function(x,y)VennDiagram::venn.diagram(
  x = x,
  category.names =names(x),
  filename = paste0('Venn_Human_processing ',paste("TPP")),
  output = TRUE ,
  imagetype="png" ,
  height = 528 , 
  width = 528 , 
  resolution = 600,
  compression = "lzw",
  lwd = 1,
  col=y,
   cex=0.5,
  cat.cex=0.3,
  rotation.degree=-90,
     cat.pos = c(180,0),
          cat.dist = c(0.02, 0.02),
  scaled=FALSE,
  inverted=FALSE
  
))
  

purrr::map2(compare_proc[2],colors[2],function(x,y)VennDiagram::venn.diagram(
  x = x,
  category.names =names(x),
  filename = paste0('Venn_Human_processing ',paste("NPARC")),
  output = TRUE ,
  imagetype="png" ,
  height = 528 , 
  width = 528 , 
  resolution = 600,
  compression = "lzw",
  lwd = 1,
  col=y,
  cex=0.5,
  cat.cex=0.3,
  rotation.degree=-90,
    cat.pos = c(180,0),
    cat.dist = c(0.02, 0.02),
  scaled=FALSE,
  inverted=FALSE
  
))


purrr::map2(compare_proc[3],colors[3],function(x,y)VennDiagram::venn.diagram(
  x = x,
  category.names =names(x),
  filename = paste0('Venn_Human_processing ',paste("SCAM")),
  output = TRUE ,
  imagetype="png" ,
  height = 528 , 
  width = 528 , 
  resolution = 600,
  compression = "lzw",
  lwd = 1,
  col=y,
  cex=0.5,
  cat.cex=0.3,
  rotation.degree=90,
    cat.pos = c(180,0),
    cat.dist = c(0.02, 0.02),
  scaled=FALSE,
  inverted=FALSE
  
))

purrr::map2(compare_proc[4],colors[4],function(x,y)VennDiagram::venn.diagram(
  x = x,
  category.names =names(x),
  filename = paste0('Venn_Human_processing ',paste("MSstatsTMT")),
  output = TRUE ,
  imagetype="png" ,
  height = 528 , 
  width = 528 , 
  resolution = 600,
  compression = "lzw",
  lwd = 1,
  col=y,
  cex=0.5,
  cat.cex=0.3,
  rotation.degree=90,
     cat.pos = c(180,0),
          cat.dist = c(0.02, 0.02),
  scaled=FALSE,
  inverted=FALSE
  
))
```
#O. Figure S-18
For the total number of proteins

```{r}
#remove shared proteins
PSMs<-PSMs[!stringr::str_detect(PSMs$Master.Protein.Accessions,";"),]

Total_prot<-list("TPP sigmoid"=unique(PSMs$Master.Protein.Accessions),"NPARC"=unique(PSMs$Master.Protein.Accessions),"SCAM"=unique(PSMs$Master.Protein.Accessions),"MSstatsTMT"=unique(PSMs$Master.Protein.Accessions))
#remove shared accessions
Total_prot<-lapply(Total_prot,function(x) {
  y<-x[!stringr::str_detect(x,";")]
  y<-unique(stringr::str_remove(y,"-[:digit:]"))
  print(paste0(length(y)," out of ",length(x)," proteins have unique protein groups"))
  return(y)})
#remove missing values
Total_prot<-lapply(Total_prot,function(x) as.character(x)|>na.omit())

#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Total_prot,function(x) sum(as.character(x)%in%kinases))

Total_prot_n<-purrr::map2(Total_prot,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="PSMs (unique protein groups):\n from PD",Analysis=c("TPP sigmoid","NPARC","SCAM","MSstatsTMT"))
```
###Then after MSstatsTMT processing

```{r}
#remove shared proteins
summarised.proteins$ProteinLevelData<-summarised.proteins$ProteinLevelData[!stringr::str_detect(summarised.proteins$ProteinLevelData$Protein,";"),]

Output_proc<-list("TPP sigmoid"=unique(summarised.proteins$ProteinLevelData$Protein),"NPARC"=unique(summarised.proteins$ProteinLevelData$Protein),"SCAM"=unique(summarised.proteins$ProteinLevelData$Protein),"MSstatsTMT"=unique(summarised.proteins$ProteinLevelData$Protein))
#remove shared accessions
Output_proc<-lapply(Output_proc,function(x) {y<-x[!stringr::str_detect(x,";")]
                    y<-unique(stringr::str_remove(y,"-[:digit:]"))
                    return(y)})
#remove missing values
Output_proc<-lapply(Output_proc,function(x) as.character(x)|>na.omit())

#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Output_proc,function(x) sum(x%in%kinases))

Output_proc_n<-purrr::map2(Output_proc,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: aggregated by \n MSstatsTMT (Table 1)",Analysis=c("TPP sigmoid","NPARC","SCAM","MSstatsTMT"))
```
###Statistical model fit convergence

```{r}
Benchmarks_MSstatsTMTproc<-list("TPP sigmoid"=unique(TPPtr_human_results$Protein_ID[TPPtr_human_results$model_converged_Treatment_1 & TPPtr_human_results$model_converged_Treatment_2 & TPPtr_human_results$model_converged_Vehicle_1 & TPPtr_human_results$model_converged_Vehicle_2]),"NPARC"=unique(NPARC_test_emp$id),"SCAM"=unique(DIM_Human_SCAM$Accession),"MSstatsTMT"=unique(DIM_late$ComparisonResult$Protein[is.na(DIM_late$ComparisonResult$issue)]))
#remove shared accessions
Benchmarks_MSstatsTMTproc<-lapply(Benchmarks_MSstatsTMTproc,function(x) x[!stringr::str_detect(x,";")])
#remove missing values
Benchmarks_MSstatsTMTproc<-lapply(Benchmarks_MSstatsTMTproc,function(x) as.character(x)|>na.omit())

Benchmarks_MSstatsTMTproc<-purrr::map2(Benchmarks_MSstatsTMTproc,Output_proc,function(x,y)y[y %in% x])
#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Benchmarks_MSstatsTMTproc,function(x) sum(x%in%kinases))

Benchmarks_MSstatsTMTproc_n<-purrr::map2(Benchmarks_MSstatsTMTproc,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: converged fit\n(Table 2, steps 1-3)",Analysis=c("TPP sigmoid","NPARC","SCAM","MSstatsTMT"))
```
###For the proteins that passed R\^2 and plateau filters

```{r}
TPPtr_filters<-unique(TPPtr_human_results$Protein_ID[TPPtr_human_results$passed_filter_Vehicle_1_vs_Treatment_1&TPPtr_human_results$passed_filter_Vehicle_2_vs_Treatment_2])

#remove shared accessions
TPPtr_filters<-TPPtr_filters[!stringr::str_detect(TPPtr_filters,";")]
#remove missing values
TPPtr_filters<-TPPtr_filters|>na.omit()


Benchmarks_MSstatsTMTproc_filt<-purrr::map2(Benchmarks_MSstatsTMTproc,names(Benchmarks_MSstatsTMTproc),function(x,y) ifelse(y=="NPARC",sum(x %in% TPPtr_filters),sum(x%in%x)))

Benchmarks_MSstatsTMTproc_filt<-lapply(Benchmarks_MSstatsTMTproc_filt,function(x) as.character(x)|>na.omit())
#verify if targets are present in the filtered data
Benchmarks_MSstatsTMTproc_targ<-
  purrr::map2(Benchmarks_MSstatsTMTproc,names(Benchmarks_MSstatsTMTproc),function(x,y) ifelse(y=="NPARC",sum(x %in% TPPtr_filters& x%in%kinases),sum(x%in%kinases)))

Benchmarks_MSstatsTMTproc_filt_n<-purrr::map2(Benchmarks_MSstatsTMTproc_filt,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(x),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: after filtering \n(Table 2, steps 1-4)",Analysis=c("TPP sigmoid","NPARC","SCAM","MSstatsTMT"))
```
###For differentially expressed proteins

```{r}
Benchmarks_MSstatsTMTproc_p<-list("TPP sigmoid"=unique(TPPtr_human_results$Protein_ID[TPPtr_human_results$pVal_adj_Vehicle_1_vs_Treatment_1<0.05 & TPPtr_human_results$pVal_adj_Vehicle_2_vs_Treatment_2 < 0.05 & TPPtr_human_results$Protein_ID %in% TPPtr_filters]),"NPARC"=unique(as.character(NPARC_test_emp$id)[NPARC_test_emp$pAdj<0.05&NPARC_test_emp$id %in% TPPtr_filters]),"SCAM"=unique(DIM_Human_SCAM$Accession[DIM_Human_SCAM$ATE_padjBH<0.05]),"MSstatsTMT"=unique(DIM_late$ComparisonResult$Protein[DIM_late$ComparisonResult$adj.pvalue<0.05]))
#remove shared accessions
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) x[!stringr::str_detect(x,";")])
#remove missing values
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) as.character(x)|>na.omit())

#verify if differentially abundant proteins are present in the filtered data
Benchmarks_MSstatsTMTproc_targ<-
  purrr::map2(Benchmarks_MSstatsTMTproc_p,names(Benchmarks_MSstatsTMTproc_p),function(x,y) ifelse(y=="NPARC"|y=="TPP",sum(x %in% TPPtr_filters&x%in%kinases),sum(x%in%kinases)))

Benchmarks_MSstatsTMTproc_p_n<-purrr::map2(Benchmarks_MSstatsTMTproc_p,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: differential abundance \n(Table 2, steps 1-5)",Analysis=c("TPP sigmoid","NPARC","SCAM","MSstatsTMT"))
```
###Save R files

```{r}
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) as.character(x)|>na.omit())

names(Benchmarks_MSstatsTMTproc_p)<-c("TPP stat. model","NPARC stat. model","SCAM stat. model","MSstatsTMT stat. model")
Human_MSstatsTMTprocesed<-Benchmarks_MSstatsTMTproc_p
saveRDS(Human_MSstatsTMTprocesed,"Thermal_sigmoid_MSstatsTMTprocesed.RDS")
```
###Keep kinase interactors from each result

```{r}
NPARC_human<-NPARC_test_emp|>dplyr::filter(id %in% kinases)|>dplyr::mutate(Protein=id)

TPP_human<-TPPtr_human_results|>dplyr::filter(ProteinID %in% kinases)|>dplyr::mutate(Protein=ProteinID)

SCAM_human<-DIM_Human_SCAM|>dplyr::filter(Accession %in% kinases)|>dplyr::mutate(Protein=Accession)

MSstat_human<-DIM_late$ComparisonResult|>dplyr::filter(Protein%in%kinases)

Stat_mod<-proteins|>as.data.frame()|>dplyr::filter(Protein%in% c("P36507","Q02750","Q13188","O14757"))|>dplyr::mutate(Accession=Protein)|>dplyr::left_join(TPP_human)|>dplyr::left_join(NPARC_human|>dplyr::select(-df1,-df2))|>dplyr::left_join(SCAM_human)|>dplyr::left_join(MSstat_human)|>dplyr::group_by(Accession)|>dplyr::mutate(NPARC_adjpval=formatC(pAdj, format = "e", digits = 2),TPP_adjpval=NaN,SCAM_adjpval=formatC(ATE_padjBH,format = "e", digits = 2),MSstats_adjpval=formatC(adj.pvalue,format = "e", digits = 2))|>dplyr::group_split()



```

###Append MSstatsTMT fitted models to the data

```{r}


DIM_targets<-DIM_late$FittedModel[which(names(DIM_late$FittedModel) %in% c("P36507","Q02750","Q13188","O14757"))]
fitted_MSstat<-purrr::map2(Stat_mod,DIM_targets,function(x,y)x|>dplyr::mutate(model=list(y)))|>dplyr::bind_rows()
```

#P. Plot the curves For Figures S-18 S-20 S-22 and save the data

```{r}
targets<-fitted_MSstat|>dplyr::group_by(Protein)|>dplyr::group_split()

nam<-as.character(unique(dplyr::bind_rows(fitted_MSstat)$Protein))
target_curves<-lapply(targets,function(x){tryCatch(plotMethods(x,temps=c("54","57","61.8"),labels=c("E","F","G","H"),processing="MSstatsTMT",fit="Sigmoid"))
})
names(target_curves)<-nam

#set path
path<-getwd()

target_curves$P36507
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Curves_MSstatsTMT_Sigmoid_P36507.tiff")

target_curves$Q02750
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Curves_MSstatsTMT_Sigmoid_Q02750.tiff")

target_curves$Q13188
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Curves_MSstatsTMT_Sigmoid_Q13188.tiff")

target_curves$O14757
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Curves_MSstatsTMT_Sigmoid_O14757.tiff")
```

#Q. Figure S-25 panel C bar charts

```{r}
bar_human<-dplyr::bind_rows(Total_prot_n,Output_proc_n,Benchmarks_MSstatsTMTproc_n,Benchmarks_MSstatsTMTproc_filt_n,Benchmarks_MSstatsTMTproc_p_n)

bar_human$Analysis<-factor(bar_human$Analysis,levels=c("TPP sigmoid","NPARC","SCAM","MSstatsTMT"))

col<-data.frame(Analysis=factor(unique(bar_human$Analysis),levels=c("TPP","NPARC","SCAM","MSstatsTMT")),"stat_model"=c("#D95F0E","#FEC44F","#2C7FB8","#07fff8"))


bar_human<-bar_human|>dplyr::inner_join(col)

bar_human$Analysis<-factor(paste0("MSstatsTMT proc., ",bar_human$Analysis," model"),levels=c("MSstatsTMT proc., TPP model","MSstatsTMT proc., NPARC model","MSstatsTMT proc., SCAM model","MSstatsTMT proc., MSstatsTMT model"))

bar_human$Steps<-factor(bar_human$Steps,levels=c("Proteins: differential abundance \n(Table 2, steps 1-5)","Proteins: after filtering \n(Table 2, steps 1-4)","Proteins: converged fit\n(Table 2, steps 1-3)","Proteins: aggregated by \n MSstatsTMT (Table 1)","PSMs (unique protein groups):\n from PD"))


bar_human$Protein_targ<-paste0(bar_human$Proteins," ","(",bar_human$ver_targets,")")

bHuman<-ggplot(bar_human|>dplyr::group_by(Analysis),mapping=aes(x=Steps,y=as.integer(Proteins),alpha=Steps,fill=stat_model))+geom_col(stat_count=aes(x=Steps,y=Proteins),colour="black")+scale_y_continuous(limits=c(0,22000),breaks = c(0,10000,20000))+ylab("Number of proteins remaining after each step")+coord_flip()+facet_wrap(~Analysis,nrow=1, labeller = label_wrap_gen(width=20))+scale_fill_manual(values=c("#2C7FB8","#07fff8","#D95F0E","#FEC44F"))+xlab("Steps")+geom_text(aes(label=Protein_targ),size=8,position=position_dodge(width=0.5),hjust=-0.350,alpha=0.9)+theme(text=element_text(size=25,                          color = "black"),axis.text.x = element_text(size=25,face="bold"),axis.text.y=element_text(size=25,face="bold"),axis.title.x = element_text(size=25),axis.title.y=element_text(size=25),strip.text.x=element_text(size=25),legend.position="none", strip.placement = "outside")+geom_rect(data = subset(bar_human, Analysis %in% "MSstatsTMT proc., MSstatsTMT model"), 
                          fill = NA, colour = "green", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf,size=2)
path = getwd()
bHuman
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Bar_chartssigmoid_MSstatsTMT.tiff")
```
#R.Figure S-27 For the total number of proteins

```{r}
#remove shared proteins
PSMs<-PSMs[!stringr::str_detect(PSMs$Master.Protein.Accessions,";"),]

Total_prot<-list("TPP"=unique(PSMs$Master.Protein.Accessions),"NPARC"=unique(PSMs$Master.Protein.Accessions),"SCAM"=unique(PSMs$Master.Protein.Accessions),"MSstatsTMT"=unique(PSMs$Master.Protein.Accessions))
#remove shared accessions
Total_prot<-lapply(Total_prot,function(x) {
  y<-x[!stringr::str_detect(x,";")]
  y<-unique(stringr::str_remove(y,"-[:digit:]"))
  print(paste0(length(y)," out of ",length(x)," proteins have unique protein groups"))
  return(y)})
#remove missing values
Total_prot<-lapply(Total_prot,function(x) as.character(x)|>na.omit())

#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Total_prot,function(x) sum(as.character(x)%in%kinases))

Total_prot_n<-purrr::map2(Total_prot,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="PSMs (unique protein groups):\n from PD",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
###Then after MSstatsTMT processing

```{r}
#remove shared proteins
summarised.proteins$ProteinLevelData<-summarised.proteins$ProteinLevelData[!stringr::str_detect(summarised.proteins$ProteinLevelData$Protein,";"),]

Output_proc<-list("TPP"=unique(summarised.proteins$ProteinLevelData$Protein),"NPARC"=unique(summarised.proteins$ProteinLevelData$Protein),"SCAM"=unique(summarised.proteins$ProteinLevelData$Protein),"MSstatsTMT"=unique(summarised.proteins$ProteinLevelData$Protein))
#remove shared accessions
Output_proc<-lapply(Output_proc,function(x) {y<-x[!stringr::str_detect(x,";")]
                    y<-unique(stringr::str_remove(y,"-[:digit:]"))
                    return(y)})
#remove missing values
Output_proc<-lapply(Output_proc,function(x) as.character(x)|>na.omit())

#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Output_proc,function(x) sum(x%in%kinases))

Output_proc_n<-purrr::map2(Output_proc,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: aggregated by \n MSstatsTMT (Table 1)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
###Statistical model fit convergence

```{r}
Benchmarks_MSstatsTMTproc<-list("TPP"=unique(TPP_human_results_F$uniqueID[!is.na(TPP_human_results_F$p_adj_NPARC)]),"NPARC"=unique(NPARC_test_emp$id[!is.na(NPARC_test_emp$pAdj)]),"SCAM"=unique(DIM_Human_SCAM$Accession),"MSstatsTMT"=unique(DIM_mid$ComparisonResult$Protein[is.na(DIM_mid$ComparisonResult$issue)]))
#remove shared accessions
Benchmarks_MSstatsTMTproc<-lapply(Benchmarks_MSstatsTMTproc,function(x) x[!stringr::str_detect(x,";")])
#remove missing values
Benchmarks_MSstatsTMTproc<-lapply(Benchmarks_MSstatsTMTproc,function(x) as.character(x)|>na.omit())

Benchmarks_MSstatsTMTproc<-purrr::map2(Benchmarks_MSstatsTMTproc,Output_proc,function(x,y)y[y %in% x])
#verify if targets are present in the Statistical model fit convergence
Benchmarks_MSstatsTMTproc_targ<-purrr::map(Benchmarks_MSstatsTMTproc,function(x) sum(x%in%kinases))

Benchmarks_MSstatsTMTproc_n<-purrr::map2(Benchmarks_MSstatsTMTproc,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: converged fit\n(Table 2, steps 1-3)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
###For the proteins that passed R\^2 and plateau filters

```{r}
TPPtr_filters<-unique(TPPtr_human_results$Protein_ID[TPPtr_human_results$passed_filter_Vehicle_1_vs_Treatment_1&TPPtr_human_results$passed_filter_Vehicle_2_vs_Treatment_2])

#remove shared accessions
TPPtr_filters<-TPPtr_filters[!stringr::str_detect(TPPtr_filters,";")]
#remove missing values
TPPtr_filters<-TPPtr_filters|>na.omit()


Benchmarks_MSstatsTMTproc_filt<-purrr::map2(Benchmarks_MSstatsTMTproc,names(Benchmarks_MSstatsTMTproc),function(x,y) ifelse(y=="NPARC",sum(x %in% TPPtr_filters),sum(x%in%x)))

Benchmarks_MSstatsTMTproc_filt<-lapply(Benchmarks_MSstatsTMTproc_filt,function(x) as.character(x)|>na.omit())
#verify if targets are present in the filtered data
Benchmarks_MSstatsTMTproc_targ<-
  purrr::map2(Benchmarks_MSstatsTMTproc,names(Benchmarks_MSstatsTMTproc),function(x,y) ifelse(y=="NPARC",sum(x %in% TPPtr_filters& x%in%kinases),sum(x%in%kinases)))

Benchmarks_MSstatsTMTproc_filt_n<-purrr::map2(Benchmarks_MSstatsTMTproc_filt,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(x),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: after filtering \n(Table 2, steps 1-4)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
###For differentially expressed proteins

```{r}
Benchmarks_MSstatsTMTproc_p<-list("TPP"=unique(TPP_human_results_F$uniqueID[TPP_human_results_F$p_adj_NPARC<0.05&TPP_human_results_F$uniqueID%in%TPPtr_filters]),"NPARC"=unique(as.character(NPARC_test_emp$id)[NPARC_test_emp$pAdj<0.05&NPARC_test_emp$id %in% TPPtr_filters]),"SCAM"=unique(DIM_Human_SCAM$Accession[DIM_Human_SCAM$ATE_padjBH<0.05]),"MSstatsTMT"=unique(DIM_mid$ComparisonResult$Protein[DIM_mid$ComparisonResult$adj.pvalue<0.05]))
#remove shared accessions
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) x[!stringr::str_detect(x,";")])
#remove missing values
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) as.character(x)|>na.omit())

#verify if differentially abundant proteins are present in the filtered data
Benchmarks_MSstatsTMTproc_targ<-
  purrr::map2(Benchmarks_MSstatsTMTproc_p,names(Benchmarks_MSstatsTMTproc_p),function(x,y) ifelse(y=="NPARC"|y=="TPP",sum(x %in% TPPtr_filters&x%in%kinases),sum(x%in%kinases)))

Benchmarks_MSstatsTMTproc_p_n<-purrr::map2(Benchmarks_MSstatsTMTproc_p,Benchmarks_MSstatsTMTproc_targ,function(x,y) data.frame(Proteins=as.character(length(unique(x))),ver_targets=as.character(y)))|>dplyr::bind_rows()|>dplyr::mutate(Steps="Proteins: differential abundance \n(Table 2, steps 1-5)",Analysis=c("TPP","NPARC","SCAM","MSstatsTMT"))
```
###Save R files

```{r}
Benchmarks_MSstatsTMTproc_p<-lapply(Benchmarks_MSstatsTMTproc_p,function(x) as.character(x)|>na.omit())

names(Benchmarks_MSstatsTMTproc_p)<-c("TPP stat. model","NPARC stat. model","SCAM stat. model","MSstatsTMT stat. model")
Human_MSstatsTMTprocesed<-Benchmarks_MSstatsTMTproc_p
saveRDS(Human_MSstatsTMTprocesed,"Thermal_mid_MSstatsTMTprocesed.RDS")
```

#S. Figure S-27, panel C bar charts

```{r}
bar_human<-dplyr::bind_rows(Total_prot_n,Output_proc_n,Benchmarks_MSstatsTMTproc_n,Benchmarks_MSstatsTMTproc_filt_n,Benchmarks_MSstatsTMTproc_p_n)

bar_human$Analysis<-factor(bar_human$Analysis,levels=c("TPP","NPARC","SCAM","MSstatsTMT"))

col<-data.frame(Analysis=factor(unique(bar_human$Analysis),levels=c("TPP","NPARC","SCAM","MSstatsTMT")),"stat_model"=c("#D95F0E","#FEC44F","#2C7FB8","#07fff8"))


bar_human<-bar_human|>dplyr::inner_join(col)

bar_human$Analysis<-factor(paste0("MSstatsTMT proc., ",bar_human$Analysis," model"),levels=c("MSstatsTMT proc., TPP model","MSstatsTMT proc., NPARC model","MSstatsTMT proc., SCAM model","MSstatsTMT proc., MSstatsTMT model"))

bar_human$Steps<-factor(bar_human$Steps,levels=c("Proteins: differential abundance \n(Table 2, steps 1-5)","Proteins: after filtering \n(Table 2, steps 1-4)","Proteins: converged fit\n(Table 2, steps 1-3)","Proteins: aggregated by \n MSstatsTMT (Table 1)","PSMs (unique protein groups):\n from PD"))


bar_human$Protein_targ<-paste0(bar_human$Proteins," ","(",bar_human$ver_targets,")")

bHuman<-ggplot(bar_human|>dplyr::group_by(Analysis),mapping=aes(x=Steps,y=as.integer(Proteins),alpha=Steps,fill=stat_model))+geom_col(stat_count=aes(x=Steps,y=Proteins),colour="black")+scale_y_continuous(limits=c(0,22000),breaks = c(0,10000,20000))+ylab("Number of proteins remaining after each step")+coord_flip()+facet_wrap(~Analysis,nrow=1, labeller = label_wrap_gen(width=20))+scale_fill_manual(values=c("#2C7FB8","#07fff8","#D95F0E","#FEC44F"))+xlab("Steps")+geom_text(aes(label=Protein_targ),size=8,position=position_dodge(width=0.5),hjust=-0.350,alpha=0.9)+theme(text=element_text(size=25,                          color = "black"),axis.text.x = element_text(size=25,face="bold"),axis.text.y=element_text(size=25,face="bold"),axis.title.x = element_text(size=25),axis.title.y=element_text(size=25),strip.text.x=element_text(size=25),legend.position="none", strip.placement = "outside")+geom_rect(data = subset(bar_human, Analysis %in% "MSstatsTMT proc., MSstatsTMT model"), 
                          fill = NA, colour = "green", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf,size=2)
path = getwd()
bHuman
ggplot2::ggsave(path = path, width = 24, height = 6.5, device='tiff', dpi=600, filename = "Bar_charts_MSstatsTMT.tiff")
```


